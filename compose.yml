# SECURITY CHECKLIST - Review before adding any Docker configuration:
# [ ] Is Docker socket mount really needed? (Usually NO - see security docs)
# [ ] Are services running as non-root users?
# [ ] Are secrets in .env file (not hardcoded in compose.yml)?
# [ ] Are unnecessary ports closed?
# [ ] Are resource limits defined?
# [ ] Are volumes properly scoped?
# [ ] Is .env file properly ignored by git?

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount source code for live editing
      - .:/app
      # SECURITY: Docker socket mount removed to prevent container escape
      # This migration tool uses SSH-based remote Docker client - no local Docker daemon access needed
      # See src/clients/docker_client.py for SSH-based Docker operations
    environment:
      - DOCKER_HOST=ssh://user@remote-host
      # Use SSH_AUTH_SOCK for key-based authentication
      - SSH_AUTH_SOCK=/run/ssh-agent
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Mock Jira API server
  mock-jira:
    image: stoplight/prism:5.14.2
    command: mock -h 0.0.0.0 --cors /tmp/jira-api.yaml
    volumes:
      - ./tests/fixtures/jira-api.yaml:/tmp/jira-api.yaml
    ports:
      - "4010:4010"
    restart: unless-stopped

  # Mock OpenProject API server
  mock-openproject:
    image: stoplight/prism:5.14.2
    command: mock -h 0.0.0.0 --cors /tmp/openproject-api.yaml
    volumes:
      - ./tests/fixtures/openproject-api.yaml:/tmp/openproject-api.yaml
    ports:
      - "4011:4010"
    restart: unless-stopped

  # Redis for caching and task queues
  redis:
    image: redis:7.4-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-defaultpassword}

  # PostgreSQL for data storage
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-jira_migration}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-defaultpassword}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  redis_data:
  postgres_data:
